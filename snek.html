<!doctype html><html lang=en><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Snek</title><style>#app,body{color:#fff;background-color:#000;margin:0;padding:0;height:100vh;width:100vw;font-family:"Franklin Gothic Medium","Arial Narrow",Arial,sans-serif}#app{position:relative}.game-board{border:1px solid #8b4513;width:calc(min(100vh,100vw) - 2px);height:calc(min(100vh,100vw) - 2px);margin:auto;display:grid}.centered{margin:auto}.tile{border:1px solid #8b4513}.snake-body{background-color:green}.snake-head{background-color:#90ee90}.timer-1 .snake-body{background-color:#b8860b}.timer-2 .snake-body{background-color:orange}.timer-3 .snake-body{background-color:salmon}.food{background-color:red}.speed-perk{background-color:#8a2be2}.speed-perk.good{color:#3d3}.speed-perk.bad{box-shadow:inset 8px 8px pink,inset -8px -8px pink}.growth-perk{background-color:#00f}.growth-perk.good{color:#dd3}.health-perk{background-color:#006400}.health-perk.good{color:#66f}.good{font-weight:700}.shop-perk{position:relative}.shop-perk::before{position:absolute;top:50%;left:50%;content:"💰";transform:translate(-50%,-50%);font-size:1.5rem}.stats{list-style:none;padding:0;margin:0}.shop-container{width:100%}.perk-item{justify-self:center;text-align:center;padding:.5rem;border-radius:1rem;width:50%}.perk-item>input[type=checkbox]{-webkit-appearance:none;appearance:none;background-color:#fff;margin:0;font:inherit;color:currentColor;width:1.15em;height:1.15em;border:.15em solid currentColor;border-radius:.15em;transform:translateY(-.075em);display:grid;place-content:center}.perk-item>input[type=checkbox]::before{content:"";width:.65em;height:.65em;transform:scale(0);transition:120ms transform ease-in-out;box-shadow:inset 1em 1em green}.perk-item:has(input[type=checkbox]:disabled){background-color:grey!important}.perk-item>input[type=checkbox]:checked::before{transform:scale(1)}.hud{position:fixed;top:10%;left:calc(50% + min(100vh,100vw)/ 2 + 20px);transform:translateY(-50%);width:180px;padding:16px;background-color:rgba(0,0,0,.8);border:2px solid #8b4513;border-radius:8px;font-size:16px;line-height:1.4}.hud-item{margin-bottom:5px;padding-bottom:5px;border-bottom:1px solid #444}.hud-item .points{color:red}.hud-item:last-child{border-bottom:none;margin-bottom:0;padding-bottom:0}</style><div id=app></div><script>const build=155;let stats,newPressReady=!0,dev=!1;const CLASSES={TILE:"tile",SNAKE_BODY:"snake-body",SNAKE_HEAD:"snake-head",FOOD:"food",BAD_PERK:"bad",SPEED_PERK:"speed-perk",GROWTH_PERK:"growth-perk",HEALTH_PERK:"health-perk",SHOP_PERK:"shop-perk",GAME_BOARD:"game-board",CENTERED:"centered",STATS:"stats",SHOP_CONTAINER:"shop-container",PERKS_GRID:"perks-grid",PERK_ITEM:"perk-item",HUD:"hud",HUD_ITEM:"hud-item"},PERK_CLASSES=[CLASSES.SPEED_PERK,CLASSES.GROWTH_PERK,CLASSES.HEALTH_PERK,CLASSES.SHOP_PERK],IDS={APP:"app",BOARD:"board",HUD:"hud"},LS={PLAYER_NAME:"playerName",SEED:"seed",SCORE_BOARD:"snekHighScore"},GAME_BOARD_SIZE=25,SPEED=22,ACCELERATION=.5,OVERRIDE_SEED=localStorage.getItem(LS.SEED,null),GLOBAL_SEED=OVERRIDE_SEED??`${Date.now()}-${`${Math.random()}`.split(".")[1]}`;function getTileId({x:e,y:t}){return`${e}-${t}`}function MurmurHash3(e){let t=0;for(hash=1779033703^e.length;t<e.length;t++){let s=hash^e.charCodeAt(t);hash=Math.imul(s,3432918353),hash=hash<<13|hash>>>19}return()=>(hash=Math.imul(hash^hash>>>16,2246822507),hash=Math.imul(hash^hash>>>13,3266489909),(hash^=hash>>>16)>>>0)}function JenkinsSimpleFast32(e,t,s,a){return()=>{let n=(e|=0)-((t|=0)<<27|t>>>5)|0;return e=t^((s|=0)<<17|s>>>15),t=s+(a|=0)|0,s=a+n|0,((a=e+n|0)>>>0)/4294967296}}const generate_seed=MurmurHash3(GLOBAL_SEED),rng=JenkinsSimpleFast32(generate_seed(),generate_seed());function randomChance(e,t=()=>{}){return rng()<e/100&&(t(),!0)}function randomRangeOrExact(e){if("number"==typeof e)return e;if("object"==typeof e&&null!==e&&"min"in e&&"max"in e)return rng()*(e.max-e.min)+e.min;throw new Error("Invalid value")}function randomChoice(e){if(!Array.isArray(e)||0===e.length)throw new Error("Invalid array");return e[Math.floor(rng()*e.length)]}function statsScreen(e){const t=document.createElement("div");t.innerHTML=`\n    <ul class=${CLASSES.STATS}>\n      <li>Your score was ${e.snek.score}.</li>\n      <li>Your movement speed was ${`${e.currentSpeed}`.substring(0,6)}.</li>\n      <li>You changed directions ${e.snek.directionChanges} times.</li>\n      <li>You hit yourself ${e.timeHitSelf} times.</li>\n      <li>Seed: ${GLOBAL_SEED}</li>\n      <li>Build: ${e.buildNumber}</li>\n    </ul>\n  `;const s=document.createElement("div");s.appendChild(document.createTextNode("Enter your name: "));const a=document.createElement("input");a.type="text",a.value=e.playerName,a.onchange=t=>{e.playerName=t.target.value},s.appendChild(a),t.appendChild(s);const n=document.createElement("div");if(e.ended){const e=document.createElement("button");e.innerText="Restart",e.onclick=()=>{stats=new Game,stats.start()},n.appendChild(e)}else{const t=document.createElement("button");t.innerText="Resume",t.onclick=()=>{e.resume()},n.appendChild(t)}return t.appendChild(n),t}function kabobToTitleCase(e=""){return e.split("-").map(e=>e.charAt(0).toUpperCase()+e.slice(1)).join(" ")}function showPerk(e,t){const s=document.createElement("div");s.classList.add(CLASSES.PERK_ITEM),s.classList.add(...t.className),s.innerHTML=`\n    <h3>${kabobToTitleCase(t.type)}</h3>\n    <p>${t.effectDescription}</p>\n    <p>Cost: ${t.cost}</p>\n  `;const a=document.createElement("input");a.type="checkbox",a.id=`perk-${t.id}`;const n=e.spendablePoints<t.cost&&!e.shop.shoppingCart.some(e=>e.id===t.id);a.disabled=n;const i=e.shop.shoppingCart.some(e=>e.id===t.id);return a.checked=i,s.onclick=()=>{n||(e.shop.shoppingCart=i?e.shop.shoppingCart.filter(e=>e.id!==t.id):e.shop.shoppingCart.concat(t))},s.appendChild(a),s}function shopScreen(e){const t=document.createElement("div");t.className=CLASSES.SHOP_CONTAINER,t.innerHTML=`\n    <h2>Shop</h2>\n    <p>Your spendable points: ${e.spendablePoints}</p>\n    <ul>\n      <li><strong>Effective Speed:</strong> ${stats.currentSpeed}</li>\n      <li><strong>Effective Health:</strong> ${stats.currentHealth}</li>\n      <li><strong>Effective Growth:</strong> ${stats.growthModifier}</li>\n    </ul>\n  `;const s=document.createElement("label");s.htmlFor="apply-selected-perks",s.textContent="Apply selected perks";const a=document.createElement("input");a.type="checkbox",a.id="apply-selected-perks",a.checked=e.shop.applyTemp,a.onchange=t=>{e.shop.applyTemp=t.target.checked},t.appendChild(a),t.appendChild(s);const n=document.createElement("h3");n.textContent="Available Perks",t.appendChild(n);const i=document.createElement("div");i.className=CLASSES.PERKS_GRID,i.style.display="grid",i.style.gridTemplateColumns="repeat(auto-fit, minmax(200px, 1fr))",i.style.gap="16px",e.shop.availablePerks.forEach(t=>{i.appendChild(showPerk(e,t))}),t.appendChild(i);const r=document.createElement("button");return r.textContent="Checkout",r.onclick=()=>{e.checkoutShop()},t.appendChild(r),t}function draw({boardId:e,className:t}){const s=Array.isArray(e)?e:[e],a=Array.isArray(t)?t:t.split(" ").filter(e=>e.trim().length);s.forEach(e=>{const t=document.getElementById(e);t&&(t.className="",t.classList.add(...a))})}class Renderable{constructor({boardId:e,className:t}){this.className=t.split(" ").filter(e=>e.trim().length),this.boardId=Array.isArray(e)?e:[e]}_render(){draw({boardId:this.boardId,className:this.className})}_unrender(){draw({boardId:this.boardId,className:CLASSES.TILE})}}class Food extends Renderable{constructor(e){super({boardId:e,className:CLASSES.FOOD})}render(){this._render()}unrender(){this._unrender()}}class BasePerk extends Renderable{constructor({isTemporary:e=!1,potency:t=1,potencyFunction:s=e=>e,applyTimeDuration:a,despawnOffBoard:n=!1,despawnOffBoardDuration:i,boardId:r,className:o,isBad:h=!1,gameInstance:d,cost:c=0}){super({boardId:r,className:`${o} ${h?CLASSES.BAD_PERK:""}`}),this.id=crypto.randomUUID(),this.type=o,this.temporary=e,this.temporary&&(this.applyLength=Math.floor(1e3*randomRangeOrExact(a))),this.despawnOffBoard=n,this.despawnOffBoard&&(this.despawnOffBoardDuration=Math.floor(1e3*randomRangeOrExact(i))),this.life=0,this.eaten=!1,this.gameInstance=d,this.cost=c,this.potency=s(randomRangeOrExact(t))}get effectDescription(){return`Potency: ${this.potency}${this.temporary?` (temporary for ${this.applyLength/1e3}s)`:""}`}age(e){this.life+=e,this.life>this.despawnOffBoardDuration&&this.despawnOffBoard&&!this.eaten&&this.unrender(),this.life>this.applyLength&&this.temporary&&this.eaten&&this.unapplyPerk()}applyPerk(){this.unrender(),this.gameInstance.perksCollected++,this.temporary?(this.gameInstance.perks.push(this),this.life=0,this.eaten=!0):this.gameInstance.applyBuffs(this)}unapplyPerk(){const e=this.gameInstance.perks.findIndex(({id:e})=>e===this.id);-1!==e&&this.gameInstance.perks.splice(e,1)}render(e=()=>{}){this._render(),e()}unrender(e=()=>{}){this._unrender(),e();const t=this.gameInstance.availablePerks.findIndex(({id:e})=>e===this.id);-1!==t&&this.gameInstance.availablePerks.splice(t,1)}}function roundToNearestEighth(e){return Math.round(8*e)/8}class SpeedBoost extends BasePerk{constructor(e,t={}){t={potency:{max:-3,min:-.5},potencyFunction:roundToNearestEighth,isTemporary:!1,...t},super({boardId:e,className:CLASSES.SPEED_PERK,...t}),this.speedModifier=this.potency}get effectDescription(){return`${this.speedModifier>0?"Add":"Remove"} Speed: ${Math.abs(this.speedModifier)}${this.temporary?` (temporary for ${this.applyLength/1e3}s)`:""}`}}class GrowthBoost extends BasePerk{constructor(e,t={}){t={potency:{min:1,max:3},potencyFunction:Math.floor,applyTimeDuration:{min:15,max:45},isTemporary:!0,...t},super({boardId:e,className:CLASSES.GROWTH_PERK,...t}),this.growthAmount=this.potency,this.type="extra-food"}get effectDescription(){return`${this.growthAmount} extra fruit${this.temporary?` for ${this.applyLength/1e3}s`:""}`}}class HealthBoost extends BasePerk{constructor(e,t={}){t={potency:1,potencyFunction:Math.floor,isTemporary:!1,...t},super({boardId:e,className:CLASSES.HEALTH_PERK,...t}),this.healthModifier=this.potency,this.type="extra-health"}get effectDescription(){return`${this.healthModifier} extra health`}}class ShopPerk extends BasePerk{constructor(e,t={}){t={despawnOffBoard:!0,despawnOffBoardDuration:{min:25,max:50},className:CLASSES.SHOP_PERK,...t},super({boardId:e,...t})}applyPerk(){this.unrender(),this.gameInstance.perksCollected++,this.gameInstance.openShop()}}const shopOptions={SpeedBoost:[{cost:4,potency:-1},{cost:10,potency:{min:-.5,max:-5},isGood:!0}],GrowthBoost:[{cost:1,potency:{min:1,max:3},isTemporary:!1},{cost:6,potency:{min:3,max:12},applyTimeDuration:120,isGood:!0}],HealthBoost:[{cost:7,potency:1},{cost:10,potency:{min:2,max:4}},{cost:16,potency:{min:2,max:8},isGood:!0}]},optionsToPerkMap={SpeedBoost:SpeedBoost,GrowthBoost:GrowthBoost,HealthBoost:HealthBoost};class Shop{constructor({gameInstance:e}){this.gameInstance=e,this.isOpen=!0,this._applyTemp=!1,this.availablePerks=[];for(let e=0;e<8;e++){const[e,t]=this.randomPerk();this.addToShop(e,t)}this._shoppingCart=[]}get applyTemp(){return this._applyTemp}set applyTemp(e){this._applyTemp=e,this.gameInstance.pause(shopScreen(this.gameInstance))}get tempPerks(){return this.isOpen&&this.applyTemp?this.shoppingCart:[]}get shoppingCart(){return this._shoppingCart}set shoppingCart(e){this._shoppingCart=e,this.gameInstance.pause(shopScreen(this.gameInstance))}randomPerk(){const e=randomChoice(Object.keys(shopOptions)),t=randomChoice(shopOptions[e]);return[optionsToPerkMap[e],t]}addToShop(e,t={}){t.gameInstance=this.gameInstance,this.availablePerks.push(new e("",t))}open(){this.applyTemp=!0,this.gameInstance.pause(shopScreen(this.gameInstance))}}class Snek{constructor(e=3,t={x:1,y:0}){this.initialLength=e,this.initialVelocity=t,this.velocity=structuredClone(t),this.lastVelocity=structuredClone(t),this.directionChanges=0,this.body=[];for(let e=0;e<this.initialLength;e++)this.body.push({x:Math.floor(12.5),y:Math.floor(12.5)+e});this.baseSpeed=22}get score(){return this.body.length-this.initialLength}speedChange(e){this.baseSpeed+=e}get speed(){return Math.max(this.baseSpeed+.5*this.score,1)}get head(){return this.body[0]}get newHead(){return{x:(25+this.head.x+this.velocity.x)%25,y:(25+this.head.y+this.velocity.y)%25}}get tail(){return this.body.at(-1)}turn({x:e=0,y:t=0}){-1*this.lastVelocity.x===e&&-1*this.lastVelocity.y===t||(this.directionChanges++,this.velocity={x:e,y:t})}move(e=!1){const t=this.head;let s;return this.body.unshift(this.newHead),e||(s=this.body.pop()),this.lastVelocity=structuredClone(this.velocity),{head:t,newHead:this.head,tail:s}}}class Game{acceleration=.5;constructor(e=3,t={x:0,y:-1}){this.app=document.getElementById("app"),this.game=document.getElementById(IDS.BOARD),this.game||(this.game=document.createElement("div"),this.game.id=IDS.BOARD,this.app.appendChild(this.game)),this.hud=document.getElementById(IDS.HUD),this.hud||(this.hud=document.createElement("div"),this.hud.id=IDS.HUD,this.hud.className=CLASSES.HUD,this.app.appendChild(this.hud)),this.snek=new Snek(e,t),this.currentFood=null,this.run=!1,this.numberOfDirectionChanges=0,this.perksCollected=0,this.health=1,this.growthBoost=0,this.timeHitSelf=0,this.food=[],this.availablePerks=[],this.perks=[],this.buildNumber=dev?"development":"prod-155",this.ended=!1,this.growthOverride=!1,this.shop=null,this.spentScore=0}get playerName(){return localStorage.getItem(LS.PLAYER_NAME,"TEMP")}set playerName(e){if(localStorage.setItem(LS.PLAYER_NAME,e),this.ended){const t=localStorage.getItem(LS.SCORE_BOARD);if(t){const s=JSON.parse(t);s.at(-1).userName=e,localStorage.setItem(LS.SCORE_BOARD,JSON.stringify(s))}}}get shopPerks(){return this.shop?this.shop.tempPerks:[]}get spendablePoints(){return this.snek.score-this.spentScore-(this.shop?.shoppingCart??[]).reduce((e,t)=>e+t.cost,0)}getPerk(e){const t=this.availablePerks.findIndex(t=>t.boardId[0]===e);if(-1!==t){const e=this.availablePerks[t];return this.availablePerks.splice(t,1),e}return null}addPerk(e,t={}){const s=[...document.getElementsByClassName(CLASSES.TILE)],a=Math.floor(rng()*s.length);t.gameInstance=this;const n=new e(s[a].id,t);this.availablePerks.push(n),n.render()}addFood(){const e=[...document.getElementsByClassName(CLASSES.TILE)],t=Math.floor(rng()*e.length);this.food.push(new Food(e[t].id)),this.food.at(-1).render()}generateFood(e=null){if(e){const t=this.food.findIndex(t=>t.boardId[0]===e);t>-1&&this.food.splice(t,1)}for(;this.food.length<1+this.growthModifier;)this.addFood();randomChance(20,()=>{randomChance(25,()=>{this.addPerk(SpeedBoost,{potency:{min:.5,max:1.5},isTemporary:!0,applyTimeDuration:{min:5,max:5},despawnOffBoard:!0,despawnOffBoardDuration:{min:5,max:10},isBad:!0})})||this.addPerk(SpeedBoost)}),randomChance(3,()=>{this.addPerk(GrowthBoost)}),randomChance(3,()=>{this.addPerk(HealthBoost)}),randomChance(10,()=>{this.availablePerks.some(e=>e instanceof ShopPerk)||this.spendablePoints>=5&&this.addPerk(ShopPerk)})}turn(e){this.run&&this.snek.turn(e)}moveSnake(){if(0===this.snek.velocity.x&&0===this.snek.velocity.y)return;let e;const t=document.getElementById(getTileId(this.snek.newHead));if(t.classList.contains(CLASSES.SNAKE_BODY))this.timeHitSelf+=1,this.refreshHud(),this.currentHealth<=0?this.end():e=this.snek.move();else if(t.classList.contains(CLASSES.TILE))e=this.snek.move(this.growthOverride),this.growthOverride=!1;else if(t.classList.contains(CLASSES.FOOD))e=this.snek.move(!0),this.generateFood(t.id),this.refreshHud();else{if(!PERK_CLASSES.some(e=>t.classList.contains(e)))throw new Error("Unknown tile: "+[...t.classList]);{const s=this.getPerk(t.id);s&&(s.applyPerk(),e=this.snek.move(),this.refreshHud())}}e&&(e.tail&&draw({boardId:getTileId(e.tail),className:CLASSES.TILE}),draw({boardId:getTileId(e.head),className:CLASSES.SNAKE_BODY}),draw({boardId:t.id,className:CLASSES.SNAKE_HEAD}))}async gameLoop(){for(;this.run;){const e=await Promise.allSettled([new Promise((e,t)=>{try{this.moveSnake(),newPressReady=!0;const t=1e3/this.currentSpeed;this.availablePerks.forEach(e=>e.age(t)),this.perks.forEach(e=>e.age(t)),e()}catch(e){console.error(e),t(e)}}),new Promise(e=>{setTimeout(e,1e3/this.currentSpeed)})]);for(const t of e)"rejected"===t.status&&console.error("Promise rejected: ",t)}}async resume(){if(!this.run&&!this.ended){this.game.classList=CLASSES.GAME_BOARD,this.game.style.gridTemplateColumns="1fr ".repeat(25),this.game.style.gridTemplateRows="1fr ".repeat(25),this.game.innerHTML="";for(let e=0;e<25;e++)for(let t=0;t<25;t++){const s=document.createElement("div");s.id=getTileId({x:t,y:e}),s.classList=CLASSES.TILE,this.game.appendChild(s)}draw({boardId:this.snek.body.map(getTileId),className:CLASSES.SNAKE_BODY}),draw({boardId:getTileId(this.snek.body[0]),className:CLASSES.SNAKE_HEAD}),this.food.forEach(e=>e.render()),this.availablePerks.forEach(e=>e.render()),this.run=!0;for(let e=3;e>0;e--)this.game.classList.add(`timer-${e}`),await new Promise(e=>setTimeout(e,750)),this.game.classList.remove(`timer-${e}`);this.gameLoop()}}start(){this.resume(),this.generateFood(),this.refreshHud()}pause(e){e.classList.add(CLASSES.CENTERED),this.run=!1,this.game.innerHTML="",this.game.appendChild(e),this.game.style.gridTemplateColumns=null,this.game.style.gridTemplateRows=null}end(){this.ended=!0;const e=statsScreen(this),t=document.createElement("p");t.innerText="You've lost the game 🐍",e.insertBefore(t,e.firstChild),this.pause(e),this.setScoreBoard()}togglePause(e=""){this.run?this.pause(e):this.resume()}openShop(){this.shop=new Shop({gameInstance:this}),this.shop.open()}checkoutShop(){const e=this.shop.shoppingCart.reduce((e,t)=>e+t.cost,0);this.spentScore+=e,this.shop.shoppingCart.forEach(e=>{e.applyPerk()}),this.shop=null,this.refreshHud(),this.resume()}applyBuffs(e){e.speedModifier&&this.snek.speedChange(e.speedModifier),e.healthModifier&&(this.health+=e.healthModifier),e.growthAmount&&(this.growthBoost+=e.growthAmount)}get currentSpeed(){return this.snek.speed+this.perks.concat(this.shopPerks).reduce((e,t)=>(t.speedModifier??0)+e,0)}get currentHealth(){return this.health-this.timeHitSelf+this.shopPerks.reduce((e,t)=>(t.healthModifier??0)+e,0)}get growthModifier(){return this.growthBoost+this.perks.concat(this.shopPerks).reduce((e,t)=>(t.growthAmount??0)+e,0)}get gameLength(){return this.snek.score}refreshHud(){this.hud&&(this.hud.innerHTML=`\n      <div class="${CLASSES.HUD_ITEM}">\n        ${this.currentHealth>0?"💚".repeat(this.currentHealth):"💔"}\n      </div>\n      <div class="${CLASSES.HUD_ITEM}">\n        <strong>Spendable Points:</strong> <span class="points">${this.spendablePoints}</span>\n      </div>\n    `)}setScoreBoard(){const e=localStorage.getItem(LS.SCORE_BOARD)??"[]",t=JSON.parse(e);t.push({userName:this.playerName,gameLength:this.snek.score,gameSpeed:this.snek.speed,finalEffectiveSpeed:this.currentSpeed,perksCollected:this.perksCollected,numberOfDirectionChanges:this.snek.directionChanges,startingBody:this.snek.initialLength,acceleration:.5,initialGameSpeed:22,initialVelocity:this.snek.initialVelocity,buildNumber:this.buildNumber,timeHitSelf:this.timeHitSelf,seed:GLOBAL_SEED}),localStorage.setItem(LS.SCORE_BOARD,JSON.stringify(t))}}document.onkeydown=function(e){if("BODY"===e.target.nodeName)switch(e.key){case"ArrowUp":case"w":case"W":stats.turn({y:-1});break;case"ArrowDown":case"s":case"S":stats.turn({y:1});break;case"ArrowLeft":case"a":case"A":stats.turn({x:-1});break;case"ArrowRight":case"d":case"D":stats.turn({x:1});break;case"p":case"P":stats.pause(statsScreen(stats));break;case"r":case"R":stats.resume(),stats.ended&&(stats=new Game,stats.start());break;case" ":stats.togglePause(statsScreen(stats)),stats.ended&&(stats=new Game,stats.start())}},stats=new Game,stats.start()</script>